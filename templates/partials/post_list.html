<div class="posts-grid">
  {% for post in posts %}
  <div class="post-card">

    <!-- User Info -->
    <div class="user-section">
    
        {% if post.author.profile_pic %}
            <img src="{{ post.author.profile_pic.url }}" class="user-pic">
        {% else %}
            <img src="https://via.placeholder.com/80" class="user-pic">
        {% endif %}

      <div>
        <a href="{% url 'accounts:profile' post.author.username %}" class="notif-username">
            {{ post.author.username }}
        </a>
        <div class="user-role">@ {{ post.author.current_designation|default:"Student" }}</div>
      </div>
    </div>

    <!-- Image inside translucent box -->
    {% if post.image %}
    <div class="image-box">
        <img src="{{ post.image.url }}" class="post-image" onclick="openImageModal('{{ post.image.url }}')">
    </div>
    {% endif %}


    <!-- Title & Description -->
    <div class="body">
      <div class="post-title">{{ post.title }}</div>

      <div class="post-desc">
        {{ post.description|truncatewords:20 }}
      </div>
    </div>

    <!-- ===== Likes & Comments Section ===== -->
    <div class="stats-section">
      <div class="stat-item">
        ‚ù§Ô∏è <span>{{ post.likes_count|default:0 }}</span> Likes
      </div>
      <!---<div class="stat-item">
        üí¨ <span>{{ post.comments_count|default:0 }}</span> Comments
      </div>--->
      <div class="comments-container" id="comments-{{ post.id }}"></div>

        <button class="load-more-btn" 
                onclick="loadMoreComments({{ post.id }})"
                id="load-btn-{{ post.id }}">
            <span>{{ post.comments_count|default:0 }}</span> üí¨Comments
        </button>

    </div>

  </div>
  {% empty %}
  <div>No posts found.</div>
  {% endfor %}
</div>


<!-- FULL SCREEN IMAGE MODAL -->
<div id="imageModal" class="modal" onclick="closeImageModal()">
  <img id="modalImg" class="modal-content">
</div>


<style>
/* ===== GRID LAYOUT ===== */
.posts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 25px;
  padding: 20px;
}

/* ===== POST CARD ===== */
.post-card {
  background: rgba(255, 255, 255, 0.35);
  backdrop-filter: blur(12px);
  border-radius: 18px;
  padding: 18px;
  box-shadow: 0 4px 18px rgba(0,0,0,0.12);
  transition: 0.3s;
}

.post-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 26px rgba(0,0,0,0.18);
}

/* ===== USER SECTION ===== */
.user-section {
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-pic {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  object-fit: cover;
}

.user-name { font-weight: 600; }
.user-role { color: #777; font-size: 14px; }

/* ===== IMAGE BOX (frosted glass) ===== */
.image-box {
  background: rgba(255, 255, 255, 0.28);
  backdrop-filter: blur(10px);
  padding: 10px;
  border-radius: 14px;
  margin-top: 15px;
}

.post-image {
  width: 100%;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.25s;
}

.post-image:hover {
  transform: scale(1.03);
}

/* ===== TITLE & DESCRIPTION ===== */
.post-title {
  margin-top: 15px;
  font-size: 18px;
  font-weight: 700;
}

.post-desc {
  margin-top: 10px;
  font-size: 14px;
  line-height: 1.4;
  background: rgba(255, 255, 255, 0.20);
  backdrop-filter: blur(8px);
  padding: 10px;
  border-radius: 10px;
}

/* ===== STAT SECTION (likes/comments) ===== */
.stats-section {
  display: flex;
  justify-content: space-between;
  margin-top: 15px;
  background: rgba(255,255,255,0.25);
  padding: 10px 14px;
  border-radius: 12px;
  backdrop-filter: blur(6px);
}

.stat-item {
  font-size: 14px;
  font-weight: 600;
  color: #444;
  display: flex;
  align-items: center;
  gap: 5px;
}

/* ===== FULL SCREEN IMAGE MODAL ===== */
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(6px);
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 95%;
  max-height: 95%;
  border-radius: 10px;
}

.no-image-box {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(8px);
  padding: 20px;
  text-align: center;
  color: #666;
  border-radius: 12px;
  margin-top: 15px;
  font-style: italic;
}





.comment-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px;
  background: rgba(255,255,255,0.25);
  margin-top: 10px;
  border-radius: 10px;
  backdrop-filter: blur(8px);
}

.comment-pic {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  object-fit: cover;
}

.comment-time {
  font-size: 12px;
  color: #666;
}
.load-more-btn {
  margin-top: 8px;
  padding: 6px 12px;
  border-radius: 8px;
  background: #0b3a66;
  color: white;
  border: none;
  cursor: pointer;
}

</style>


<script>
let commentPage = {};

function loadMoreComments(postId) {

    console.log("Loading comments for", postId);  // Debug check

    if (!commentPage[postId]) commentPage[postId] = 1;

    fetch(`/posts/${postId}/comments/?page=${commentPage[postId]}`)
        .then(res => {
            console.log("Response status:", res.status);  // Debug
            return res.json();
        })
        .then(data => {

            console.log("Comments received:", data); // Debug

            const container = document.getElementById(`comments-${postId}`);

            if (!container) {
                console.error("Container not found: comments-" + postId);
                return;
            }

            data.comments.forEach(c => {
                container.innerHTML += `
                    <div class="comment-item">
                        <img src="${c.pic || 'https://via.placeholder.com/40'}" class="comment-pic">
                        <div>
                            <strong>${c.user}</strong>
                            <div>${c.text}</div>
                            <span class="comment-time">${c.time}</span>
                        </div>
                    </div>
                `;
            });

            if (!data.has_next) {
                document.getElementById(`load-btn-${postId}`).style.display = "none";
            }

            commentPage[postId]++;
        })
        .catch(err => console.error("Fetch Error:", err));
}

</script>